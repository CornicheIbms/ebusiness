<?php
/**
 *@ --------------------------------------------------
 *@ LICENSE INFORMATION          					 |
 *@ Developer: Corniche van der Burgh                |
 *@ Only to be used for the IBMS course E-business   |
 *@---------------------------------------------------
**/

class Antiexploit {

	public function detectExploit($data, $ip) 
	{
		if(filter_var($data, FILTER_VALIDATE_EMAIL)) { 
			return $data;
		}

		else if (!ctype_alnum($data))
		{

			/* Testing purposes, no actual IP ban */
			if(DEBUG == true)
			{
				/* First see if a warning has already been issued */
				$query = "SELECT * FROM warning_table WHERE ip_address = ?";
				$check = Database::checkColumn($query, array($ip));

				if($check)
				{
					/* warnings exists */
					die("Ban system is fully operational");
				}
				else
				{
					/* no warning, establish warning */
					$time = date("H:i");
					$date = date("d-m-y");
					$_query = "INSERT INTO warning_table (ip_address, time, date) VALUES (:ip, :time, :date)";
					$_params = array(":ip" => $ip, ":time" => $time, ":date" => $date);

					Database::query($_query, 'insert', $_params);
					die("EXPLOIT ATTEMPT DETECTED, THIS IS YOUR FIRST AND ONLY WARNING.<br> Warning issued on IP address: $ip");
				}
			}

			else
			{
				/* First see if a warning has already been issued */
				$prms = array($ip);
				$qry = "SELECT * FROM warnings_table WHERE ip_address = ?";
				$result = Database::checkColumn($qry, $prms);

				if($result)
				{
					/* warnings exists */
					$params2 = array($ip, "Anti exploit system auto-ban", time("H:i"), time("d-m-y"));
					$query2 = "INSERT INTO ban_table (`ip_address`, `reason`, `time`, `date`) VALUES (?, ?, ?, ?)";
					Database::query($query2, "insert", $params2);
					die("Ban system is fully operational");
				}
				else
				{
					/* no warning, establish warning */
					$_time = date("H-i-s");
					$_date = date("d-m-y");
					$q = "INSERT INTO warning_table (`ip_address`, `time`, `date`) VALUES (?, ?, ?)";
					$p = array($ip, $_time, $_date);

					Database::query($q, 'insert', $p);
					die("EXPLOIT ATTEMPT DETECTED, THIS IS YOUR FIRST AND ONLY WARNING.<br> Warning issued on IP address: $ip");
				}
			}
		}
		else
		{
			return $data;
		}
	}

	/* same function, but for numeric specific data */
	public static function detectNumericExploit($data, $ip) {
		if(!is_numeric($data))
		{
			/* Testing purposes, no actual IP ban */
			if(DEBUG == true)
			{
				/* First see if a warning has already been issued */
				$query = "SELECT * FROM warning_table WHERE ip_address = ?";
				$check = Database::checkColumn($query, array($ip));

				if($check)
				{
					/* warnings exists */
					die("Ban system is fully operational");
				}
				else
				{
					/* no warning, establish warning */
					$time = date("H:i");
					$date = date("d-m-y");
					$_query = "INSERT INTO warning_table (ip_address, time, date) VALUES (:ip, :time, :date)";
					$_params = array(":ip" => $ip, ":time" => $time, ":date" => $date);

					Database::query($_query, 'insert', $_params);
					die("EXPLOIT ATTEMPT DETECTED, THIS IS YOUR FIRST AND ONLY WARNING.<br> Warning issued on IP address: $ip");
				}
			}

			else
			{
				/* First see if a warning has already been issued */
				$prms = array($ip);
				$qry = "SELECT * FROM warnings_table WHERE ip_address = ?";
				$result = Database::checkColumn($qry, $prms);

				if($result)
				{
					/* warnings exists */
					$params2 = array($ip, "Anti exploit system auto-ban", time("H:i"), time("d-m-y"));
					$query2 = "INSERT INTO ban_table (`ip_address`, `reason`, `time`, `date`) VALUES (?, ?, ?, ?)";
					Database::query($query2, "insert", $params2);
					die("Ban system is fully operational");
				}
				else
				{
					/* no warning, establish warning */
					$_time = date("H-i-s");
					$_date = date("d-m-y");
					$q = "INSERT INTO warning_table (`ip_address`, `time`, `date`) VALUES (?, ?, ?)";
					$p = array($ip, $_time, $_date);

					Database::query($q, 'insert', $p);
					die("EXPLOIT ATTEMPT DETECTED, THIS IS YOUR FIRST AND ONLY WARNING.<br> Warning issued on IP address: $ip");
				}
			}
		}
		else
		{
			return $data;
		}
	}
}
?>
